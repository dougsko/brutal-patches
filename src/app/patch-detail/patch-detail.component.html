

<div *ngIf="patch">

  <script type="text/javascript">
    $(document).ready(function () {
        //Get all the previous connections
        var prevConnections = patch.modmatrix  != nil ? patch.modmatrix.html_safe : '[]';
        //and add them to the mod matrix
        jsPlumb.ready(function(){
            //remove all the old endpoints
            jsPlumb.deleteEveryEndpoint();
            //unbind the click to detach
            jsPlumb.unbind("click");
            jsPlumb.Defaults.Endpoint = "Dot";
            jsPlumb.Defaults.EndpointStyle = { fillStyle : "transparent" };
            jsPlumb.Defaults.Anchor = [.48, .15, 0, 0];
            jsPlumb.Defaults.PaintStyle = { lineWidth: 3, strokeStyle: "#ffa500" };
            jsPlumb.Defaults.endpointPaintStyle = { fillStyle: "blue", outlineColor: "black", outlineWidth: 1 };  
    
            for(var key in prevConnections){
                var selectedConnection = prevConnections[key];
                var modSource = selectedConnection.source;
                var modTarget = selectedConnection.target;
                //make connection
                jsPlumb.connect({source:modSource, target:modTarget, detachable:false });
            }
        });
    
        // Set the octave
        moveIndicator(patch.octave);
        $( "#octave-controls .prev, #octave-controls .next").unbind( "click" ).addClass('disabled');
        //stop them things from sliding
        $( ".toggle, .slider" ).slider( "option", "disabled", true );
        //Hide the save button
        $('#patch-reset').css('display', 'block');
        $('#patch-save, #intro-copy').hide();
    });
    </script>


  <h2>{{patch.title | uppercase}}</h2>
  <div><span>id: </span>{{patch.id}}</div>
  <div><span>sub_fifth: </span>{{patch.sub_fifth}}</div>
  <div><span>overtone: </span>{{patch.overtone}}</div>
  <div><span>triangle: </span>{{patch.triangle}}</div>
  <div>
    <label for="patch-title">Patch title: </label>
    <input id="patch-title" [(ngModel)]="patch.title" placeholder="{{patch.title}}">
  </div>


    <div id="patch" class="group">
        <div class="row top group">
            <h1>MICROBRUTE <br/><span class="grey">Patches</span></h1>
            <!-- <p id="intro-copy">Dial up your favorite Microbrute patches and click "Save" to be redirected to a page with your saved configuration.</p> -->
        </div><!-- /Row-->
        <div class="row top">
            <div id="oscillator" class="section">
                <div class="title"><span>Oscillator</span></div>
                <div class="column first">
                  <knob (newValueEvent)="updateValue('sub_fifth', $event)" name="sub_fifth" label="Sub &gt; Fifth" sFlow="true" lFlow="true" value="{{patch.sub_fifth}}"></knob>
                  <knob (newValueEvent)="updateValue('overtone', $event)" name="overtone" label="Overtone" lower="true" value="{{patch.overtone}}"></knob>
                </div>
                <div class="column">
                  <knob (newValueEvent)="updateValue('ultra_saw', $event)" name="ultra_saw" label="Ultrasaw" sFlow="true" lFlow="true" value="{{patch.ultra_saw}}"></knob>
                  <knob (newValueEvent)="updateValue('saw', $event)" name="saw" label="Saw" lower="true" value="{{patch.saw}}"></knob>
                </div>
                <div class="column">
                  <knob (newValueEvent)="updateValue('pulse_width', $event)" name="pulse_width" label="Pulse Width" sFlow="true" lFlow="true" value="{{patch.pulse_width}}"></knob>
                  <knob (newValueEvent)="updateValue('square', $event)" name="square" label="Square" lower="true" value="{{patch.square}}"></knob>
                </div>
                <div class="column">
                  <knob (newValueEvent)="updateValue('metalizer', $event)" name="metalizer" label="Metalizer" sFlow="true" lFlow="true" value="{{patch.metalizer}}"></knob>
                  <knob (newValueEvent)="updateValue('triangle', $event)" name="triangle" label="Triangle" lower="true" value="{{patch.triangle}}"></knob>
                </div>
            </div>
            <!-- / Oscillator Section -->
            <!--Filter Section -->
            <div id="filter" class="section">
                <div class="title"><span>Filter</span></div>
                <div class="column first">
                    <div class="knob-outer" id="cutoff"><div class="knob">
                      <input type="text" id="cutoff" class="dial" value="{{patch.cutoff}}">
                      <!-- <%= f.text_field :cutoff  , { class: "dial", value: "#{@patch.cutoff}" }%> -->
                    </div></div>
                    <p class="label">Cutoff</p>
                    <div class="toggle-wrap group">
                        <div class="col first">
                            <div class="toggle-outer" id="mode">
                                <div class="toggle" data-max="2"></div>
                                <input type="hidden" id="mode" class="toggle-input" value="{{patch.mode}}">
                                <!-- <%= f.hidden_field :mode, { class: "toggle-input", value: "#{@patch.mode}" } %> -->
                            </div>
                            <p class="label lower">Mode</p>
                        </div>
                        <div class="col labels">
                            <p>HP</p>
                            <p>BP</p>
                            <p>LP</p>
                        </div>
                    </div>
                </div>
                <div class="column">
                    <div class="knob-outer" id="resonance"><div class="knob">
                      <input type="text" id="resonance" class="dial" value="{{patch.resonance}}">
                      <!-- <%= f.text_field :resonance  , { class: "dial", value: "#{@patch.resonance}" }%> -->
                    </div></div>
                    <p class="label">Resonance</p>
                    <div class="knob-outer" id="env-amt"><div class="knob">
                      <input type="text" id="env_amt" class="dial" value="{{patch.env_amt}}">
                      <!-- <%= f.text_field :env_amt  , { class: "dial", value: "#{@patch.env_amt}" }%> -->
                    </div></div>
                    <p class="label lower">ENV Amt</p>
                </div>
                <div class="column">
                    <div class="knob-outer" id="brute-factor"><div class="knob">
                      <input type="text" id="brute_factor" class="dial" value="{{patch.brute_factor}}">
                      <!-- <%= f.text_field :brute_factor  , { class: "dial", value: "#{@patch.brute_factor}" }%> -->
                    </div></div>
                    <p class="label">Brute Factor</p>
                    <div class="knob-outer" id="kbd-tracking"><div class="knob">
                      <input type="text" id="kbd_tracking" class="dial" value="{{patch.kbd_tracking}}">
                      <!-- <%= f.text_field :kbd_tracking  , { class: "dial", value: "#{@patch.kbd_tracking}" }%> -->
                    </div></div>
                    <p class="label lower">KBD Tracking </p>
                </div>
            </div>
            <!-- /Filter Section -->
            <!-- Mod Matrix-->
            <div id="mod-matrix" class="section">
                <div class="title"><span>Mod Matrix</span></div>
                <div id="cv-out" class="cv"><p>CV Out</p></div>
                <div id="cv-in" class="cv"><p>CV In</p></div>
                <div id="patch-bay">
                    <div class="column first">
                        <div class="mod-outer"><p class="label lower">ENV</p></div>
                        <div class="mod-outer"><p class="label lower">LFO</p></div>
                    </div>
                    <div class="column">
                        <div class="mod-outer"><p class="label lower">Metal</p></div>
                        <div class="mod-outer"><p class="label lower">Pitch</p></div>
                    </div>
                    <div class="column">
                        <div class="mod-outer"><p class="label lower">Saw</p></div>
                        <div class="mod-outer"><p class="label lower">Filter</p></div>
                    </div>
                    <div class="column">
                        <div class="mod-outer"><p class="label lower">Sub</p></div>
                        <div class="mod-outer"><p class="label lower">PWM</p></div>
                    </div>
                    <div class="mod" id="mod-env"></div>
                    <div class="mod" id="mod-lfo"></div>
                    <div class="mod" id="mod-metal"></div>
                    <div class="mod" id="mod-pitch"></div>
                    <div class="mod" id="mod-saw"></div>
                    <div class="mod" id="mod-filter"></div>
                    <div class="mod" id="mod-sub"></div>
                    <div class="mod" id="mod-pwm"></div>
                </div>
            </div>
            <input type="hidden" id="modmatrix-input">
            <!-- <%= f.hidden_field :modmatrix  , { id: "modmatrix-input" }%> -->
            <!-- /Mod Matrix-->
            <div id="octave" class="section">
                <div class="title"><span>Octave</span></div>
                <ul id="octave-indicators" class="group">
                    <li class="label" id="neg2">-2<div class="led"></div></li>
                    <li class="label" id="neg1">-1<div class="led"></div></li>
                    <li class="label" id="zero">0<div class="led"></div></li>
                    <li class="label" id="pos1">1<div class="led"></div></li>
                    <li class="label" id="pos2">-2<div class="led"></div></li>
                </ul>
                <input type="hidden" id="octave-input" value="{{patch.octave}}">
                <!-- <%= f.hidden_field :octave  , { id: "octave-input", value: "#{@patch.octave}" } %> -->
                <ul id="octave-controls" class="group">
                    <li class="prev">Previous</li>
                    <li class="next">Next</li>
                </ul>
            </div>
            <!-- /Octave -->
            <!-- Volume-->
            <div id="volume-region">
                <div class="column first">
                    <div class="knob-outer" id="volume"><div class="knob">
                      <input type="text" id="volume" class="dial" value="{{patch.volume}}">
                      <!-- <%= f.text_field :volume  , { class: "dial", value: "#{@patch.volume}" }%> -->
                    </div></div>
                    <p class="label lower">Master Volume</p>
                </div>
            </div>
            <!-- /Volume-->
        </div><!-- /Row-->
        <div class="row">
            <!-- Controls-->
            <div id="controls" class="section">
                <div class="title"><span>Controls</span></div>
                <div class="column single">
                    <div class="knob-outer" id="glide"><div class="knob">
                      <input type="text" id="glide" class="dial" value="{{patch.glide}}">
                      <!-- <%= f.text_field :glide  , { class: "dial", value: "#{@patch.glide}" }%> -->
                    </div></div>
                    <p class="label lower">Glide</p>
                    <div class="toggle-wrap group">
                        <div class="col first">
                            <div class="toggle-outer" id="mod-wheel">
                                <div class="toggle" data-max="1"></div>
                                <input type="hidden" id="cutoff" class="toggle-input" value="{{patch.mod_wheel}}">
                                <!-- <%= f.hidden_field :mod_wheel  , { class: "toggle-input", value: "#{@patch.mod_wheel}" }%> -->
                            </div>
                            <p class="label lower">Mod Wheel</p>
                        </div>
                        <div class="col labels">
                            <p class="tall">LFO AmT</p>
                            <p>Cutoff</p>
                        </div>
                    </div>
                </div>
            </div>
            <!-- /Controls-->
            <!-- LFO-->
            <div id="lfo" class="section">
                <div class="title"><span>LFO</span></div>
                <div class="column first">
                    <div class="knob-outer" id="amount"><div class="knob">
                      <input type="text" id="amount" class="dial" value="{{patch.amount}}">
                      <!-- <%= f.text_field :amount  , { class: "dial", value: "#{@patch.amount}" }%> -->
                    </div></div>
                    <p class="label">Amount</p>
                    <div class="toggle-wrap group">
                        <div class="col first">
                            <div class="toggle-outer" id="wave">
                                <div class="toggle toggle ui-slider ui-corner-all ui-slider-vertical ui-widget ui-widget-content" data-max="2"></div>
                                <input type="hidden" name="wave" id="wave" class="toggle-input" value="{{patch.wave}}">
                                <!-- <%= f.hidden_field :wave  , { class: "toggle-input", value: "#{@patch.wave}" }%> -->
                            </div>
                            <p class="label lower">Wave</p>
                        </div>
                        <div class="col labels">
                            <p>Sq</p>
                            <p>Saw</p>
                            <p>Tri</p>
                        </div>
                    </div>
                </div>
                <div class="column">
                    <div class="knob-outer" id="rate"><div class="knob">
                      <input type="text" id="rate" class="dial" value="{{patch.rate}}">
                      <!-- <%= f.text_field :rate  , { class: "dial", value: "#{@patch.rate}" }%> -->
                    </div></div>
                    <p class="label">Rate</p>
                    <div class="toggle-wrap group">
                        <div class="col first">
                            <div class="toggle-outer" id="sync">
                                <div class="toggle" data-max="1"></div>
                                <input type="hidden" id="sync" class="toggle-input" value="{{patch.sync}}">
                                <!-- <%= f.hidden_field :sync  , { class: "toggle-input", value: "#{@patch.sync}" }%> -->
                            </div>
                            <p class="label lower">Sync</p>
                        </div>
                        <div class="col labels">
                            <p class="tall">Seq</p>
                            <p>Free</p>
                        </div>
                    </div>
                </div>
            </div>
            <!-- /LFO-->
            <!-- Envelope-->
            <div id="envelope" class="section">
                <div class="title"><span>Envelope</span></div>
                <div class="column first">
                    <div class="knob-outer" id="env-amt-2"><div class="knob">
                      <input type="text" id="env_amt_2" class="dial" value="{{patch.env_amt_2}}">
                      <!-- <%= f.text_field :env_amt_2  , { class: "dial", value: "#{@patch.env_amt_2}" }%> -->
                    </div></div>
                    <p class="label">Env Amt</p>
                    <div class="toggle-wrap group">
                        <div class="col first">
                            <div class="toggle-outer" id="vca">
                                <div class="toggle" data-max="1"></div>
                                <input type="hidden" id="vca" class="toggle-input" value="{{patch.vca}}">
                                <!-- <%= f.hidden_field :vca  , { class: "toggle-input", value: "#{@patch.vca}" }%> -->
                            </div>
                            <p class="label lower">VCA</p>
                        </div>
                        <div class="col labels">
                            <p class="tall">Env</p>
                            <p>Gate</p>
                        </div>
                    </div>
                </div>
                <div class="column first-slide">
                    <div class="slider-wrap">
                        <div class="slider-outer" id="attack">
                            <div class="slider"></div>
                            <input type="hidden" id="attack" class="slider-input" value="{{patch.attack}}">
                            <!-- <%= f.hidden_field :attack  , { class: "slider-input", value: "#{@patch.attack}" }%> -->
                        </div>
                        <p class="label lower">Attack</p>
                    </div>
                </div>
                <div class="column">
                    <div class="slider-wrap">
                        <div class="slider-outer" id="decay">
                            <div class="slider"></div>
                            <input type="hidden" id="decay" class="slider-input" value="{{patch.decay}}">
                            <!-- <%= f.hidden_field :decay  , { class: "slider-input", value: "#{@patch.decay}" }%> -->
                        </div>
                        <p class="label lower">Decay</p>
                    </div>
                </div>
                <div class="column">
                    <div class="slider-wrap">
                        <div class="slider-outer" id="sustain">
                            <div class="slider"></div>
                            <input type="hidden" id="sustain" class="slider-input" value="{{patch.sustain}}">
                            <!-- <%= f.hidden_field :sustain  , { class: "slider-input", value: "#{@patch.sustain}" }%> -->
                        </div>
                        <p class="label lower">Sustain</p>
                    </div>
                </div>
                <div class="column">
                    <div class="slider-wrap">
                        <div class="slider-outer" id="release">
                            <div class="slider"></div>
                            <input type="hidden" id="release" class="slider-input" value="{{patch.release}}">
                            <!-- <%= f.hidden_field :release  , { class: "slider-input", value: "#{@patch.release}" }%> -->
                        </div>
                        <p class="label lower">Release</p>
                    </div>
                </div>
            </div>
            <!-- /Envelope-->
            <!-- LFO-->
            <div id="sequencer" class="section">
                <div class="title"><span>Sequencer</span></div>
                <div class="column first">
                    <div class="knob-outer-p" id="pattern"><div class="knob-p">
                      <input type="text" id="pattern" class="dial-p" value="{{patch.pattern}}">
                      <!-- <%= f.text_field :pattern  , { class: "dial-p", value: "#{@patch.pattern}" }%> -->
                    </div></div>
                    <p class="label">Pattern</p>
                    <div class="toggle-wrap group">
                        <div class="col first">
                            <div class="toggle-outer" id="play">
                                <div class="toggle" data-max="2"></div>
                                <input type="hidden" id="play" class="toggle-input" value="{{patch.play}}">
                                <!-- <%= f.hidden_field :play  , { class: "toggle-input", value: "#{@patch.play}" }%> -->
                            </div>
                            <p class="label lower">Play</p>
                        </div>
                        <div class="col labels">
                            <p>Play</p>
                            <p>Off</p>
                            <p>Record</p>
                        </div>
                    </div>
                </div>
                <div class="column">
                    <div class="knob-outer" id="rate-2"><div class="knob">
                      <input type="text" id="rate" class="dial" value="{{patch.rate}}">
                      <!-- <%= f.text_field :rate  , { class: "dial", value: "#{@patch.rate}" }%> -->
                    </div></div>
                    <p class="label">Rate</p>
                </div>
            </div>
            <!-- /LFO-->
        </div><!-- /Row-->
    </div><!-- /Patch-->
    <div id="meta-info">
        <h2 id="title-text" class="editable" contenteditable="true">Title</h2>
        <p id="description-text" class="editable" contenteditable="true">Description</p>
        <p id="tag-text" class="editable" contenteditable="true">Comma separated tags</p>
        <input type="hidden" id="title-input" value="{{patch.id}}">
        <input type="hidden" id="description-input" value="{{patch.description}}">
        <!-- <%= f.hidden_field :title  , { id: "title-input", value: "#{@patch.id}" }%> -->
        <!-- <%= f.hidden_field :description  , { id: "description-input", value: "#{@patch.description}" }%> -->
        <!-- <%= f.hidden_field :tag_list , { id: "tag-list-input", value: "#{@patch.tag_list}" }%> -->
    </div>

  </div>